<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">

<canvas id=canvas_main></canvas>

<script type="module">
import { rnd } from "https://js.sabae.cc/rnd.js";
import { loadImage } from "./loadImage.js";

const sw = 256;
const cw = 16;
const nw = sw / cw;
const cwh = cw / 2;

const sh = sw;
canvas_main.width = sw;
canvas_main.height = sh;
canvas_main.style.width = "90vw";
canvas_main.style.height = "90vw";
canvas_main.style.imageRendering = "pixelated";
const g = canvas_main.getContext("2d");
g.imageSmoothingEnabled = false;

const base = "tuti1";
//const put = "kusa1";
const put = "mizu2";

const imgkusa = await loadImage("mapchip2/MapChip/" + put + ".png");
const imgbase = await loadImage("mapchip2/MapChip/" + base + ".png");
const imgs = {};
imgs[put] = imgkusa;
imgs[base] = imgbase;

const map = new Array(nw * nw);
for (let i = 0; i < map.length; i++) {
  map[i] = Math.random() < .3 ? put : base;
}

const getChip = (x, y) => {
  if (x < 0 || x >= nw || y < 0 || y >= nw) return base;
  return map[x + y * nw];
};

const drawBG = (tick) => {
  g.clearRect(0, 0, sw, sh);
  for (let y = 0; y < nw; y++) {
    for (let x = 0; x < nw; x++) {
      const n = 4;
      const img = imgs[getChip(x, y)];
      const nimg = img.width / cw;
      g.drawImage(img, tick % nimg * cw, n * cw, cw, cw, x * cw, y * cw, cw, cw);
    }
  }

  const drawChip = (imgname, n, x, y) => {
    const img = imgs[imgname];
    const nimg = img.width / cw;
    g.drawImage(img, n % nimg * cwh + tick % 2 * cw, Math.floor(n / 2) * cwh, cwh, cwh, x, y, cwh, cwh);
  };
  for (let y = 0; y < nw; y++) {
    for (let x = 0; x < nw; x++) {
      const img = getChip(x, y);
      const imgup = getChip(x, y - 1);
      const imgdown = getChip(x, y + 1);
      const imgright = getChip(x + 1, y);
      const imgleft = getChip(x - 1, y);
      const imgupright = getChip(x + 1, y - 1);
      const imgupleft = getChip(x - 1, y - 1);
      const imgdownright = getChip(x + 1, y + 1);
      const imgdownleft = getChip(x - 1, y + 1);
      if (img == base && imgup == put) {
        if (imgleft == put) {
          drawChip(put, 15, x * cw, y * cw);
        } else {
          drawChip(put, 10, x * cw, y * cw);
        }
        if (imgright == put) {
          drawChip(put, 14, x * cw + cwh, y * cw);
        } else {
          drawChip(put, 11, x * cw + cwh, y * cw);
        }
      }
      if (img == base && imgdown == put) {
        if (imgleft == put) {
          drawChip(put, 13, x * cw, y * cw + cwh);
        } else {
          drawChip(put, 8, x * cw, y * cw + cwh);
        }
        if (imgright == put) {
          drawChip(put, 12, x * cw + cwh, y * cw + cwh);
        } else {
          drawChip(put, 9, x * cw + cwh, y * cw + cwh);
        }
      }
      if (img == base && imgright == put) {
        if (imgup != put) drawChip(put, 4, x * cw + cwh, y * cw);
        if (imgdown != put) drawChip(put, 6, x * cw + cwh, y * cw + cwh);
      }
      if (img == base && imgleft == put) {
        if (imgup != put) drawChip(put, 5, x * cw, y * cw);
        if (imgdown != put) drawChip(put, 7, x * cw, y * cw + cwh);
      }
      if (img == base && imgupright == put && imgup == base && imgright == base) {
        drawChip(put, 2, x * cw + cwh, y * cw);
      }
      if (img == base && imgupleft == put && imgup == base && imgleft == base) {
        drawChip(put, 3, x * cw, y * cw);
      }
      if (img == base && imgdownright == put && imgdown == base && imgright == base) {
        drawChip(put, 0, x * cw + cwh, y * cw + cwh);
      }
      if (img == base && imgdownleft == put && imgdown == base && imgleft == base) {
        drawChip(put, 1, x * cw, y * cw + cwh);
      }
    }
  }
};

let tick = 0;
setInterval(() => {
  drawBG(tick++);
}, 500);


</script>

<style>
body {
  background-color: #333;
}
</style>
